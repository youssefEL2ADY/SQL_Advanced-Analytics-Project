CREATE VIEW gold.report_customers AS 

WITH base_query AS (
SELECT 
f.order_number,
f.product_key,
f.order_date,
f.sales_amount,
f.quantity,
c.customer_key,
 c.customer_number,
 CONCAT(c.first_name,' ',c.last_name) AS FullName,
 DATEDIFF(YEAR,c.birthdate, GETDATE()) AGE
FROM gold.fact_sales f
LEFT JOIN gold.dim_customers c
ON f.customer_key = c.customer_key
WHERE order_date IS NOT NULL
)
,
customer_aggregation AS (
SELECT 
customer_key,
 customer_number,
 FullName,
 AGE,
 COUNT(DISTINCT(order_number)) TotalOrders,
 SUM(sales_amount) AS TotalSales,
 SUM(quantity) AS Totalquantity,
  COUNT(DISTINCT(product_key)) TotalProducts,
  MAX(order_date)AS LO,
  DATEDIFF(MONTH,MIN(order_date),MAX(order_date)) AS LifeSpan
 FROM base_query
 GROUP BY customer_key,
 customer_number,
 FullName,
 AGE
 )
 SELECT 
 customer_key,
 customer_number,
 FullName,
 AGE,
 CASE WHEN AGE < 20 THEN 'under 20'
      WHEN AGE BETWEEN 20 AND 29 THEN '20-29'
	  WHEN AGE BETWEEN 30 AND 39 THEN '30-39'
	  WHEN AGE BETWEEN 40 AND 49 THEN '40-49'
	  ELSE '50 AND above'
	  END Age_Group,
 CASE WHEN LifeSpan >= 12 AND TotalSales >5000 THEN 'VIP'
     WHEN LifeSpan >= 12 AND TotalSales <=5000 THEN 'Regular'
	 ELSE 'NEW'
	 END CustomerSegment,
	 LO,
	 DATEDIFF(MONTH,LO, GETDATE()) AS Recency,
  TotalOrders,
  TotalSales,
  Totalquantity,
  TotalProducts,
  LifeSpan,
  CASE WHEN TotalSales = 0 THEN 0 
  ELSE TotalSales / TotalOrders 
  END AVG_order_value,
  CASE WHEN LifeSpan = 0 THEN TotalSales 
       ELSE TotalSales / LifeSpan 
	   END AVG_monthly_spend
  FROM customer_aggregation



  SELECT * FROM gold.report_customers
